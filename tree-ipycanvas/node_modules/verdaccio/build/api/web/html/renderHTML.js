"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = renderHTML;
exports.resolveLogo = resolveLogo;
exports.validatePrimaryColor = validatePrimaryColor;

var _debug = _interopRequireDefault(require("debug"));

var _lruCache = _interopRequireDefault(require("lru-cache"));

var _path = _interopRequireDefault(require("path"));

var _url = require("url");

var _commonsApi = require("@verdaccio/commons-api");

var _constants = require("../../../lib/constants");

var _utils = require("../../../lib/utils");

var _template = _interopRequireDefault(require("./template"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const pkgJSON = require('../../../../package.json');

const DEFAULT_LANGUAGE = 'es-US';
const cache = new _lruCache.default({
  max: 500,
  maxAge: 1000 * 60 * 60
});
const debug = (0, _debug.default)('verdaccio');
const defaultManifestFiles = {
  js: ['runtime.js', 'vendors.js', 'main.js'],
  ico: 'favicon.ico'
};

function validatePrimaryColor(primaryColor) {
  const isHex = /^#+([a-fA-F0-9]{6}|[a-fA-F0-9]{3})$/i.test(primaryColor);

  if (!isHex) {
    debug('invalid primary color %o', primaryColor);
    return;
  }

  return primaryColor;
}

function resolveLogo(config, req) {
  var _config$web, _config$web2, _config$web4;

  const isLocalFile = (config === null || config === void 0 ? void 0 : (_config$web = config.web) === null || _config$web === void 0 ? void 0 : _config$web.logo) && !(0, _utils.isHTTPProtocol)(config === null || config === void 0 ? void 0 : (_config$web2 = config.web) === null || _config$web2 === void 0 ? void 0 : _config$web2.logo);

  if (isLocalFile) {
    var _config$web3;

    return `${(0, _utils.getPublicUrl)(config === null || config === void 0 ? void 0 : config.url_prefix, req)}-/static/${_path.default.basename(config === null || config === void 0 ? void 0 : (_config$web3 = config.web) === null || _config$web3 === void 0 ? void 0 : _config$web3.logo)}`;
  } else if ((0, _utils.isHTTPProtocol)(config === null || config === void 0 ? void 0 : (_config$web4 = config.web) === null || _config$web4 === void 0 ? void 0 : _config$web4.logo)) {
    var _config$web5;

    return config === null || config === void 0 ? void 0 : (_config$web5 = config.web) === null || _config$web5 === void 0 ? void 0 : _config$web5.logo;
  } else {
    return '';
  }
}

function renderHTML(config, manifest, manifestFiles, req, res) {
  var _config$i18n$web, _config$i18n, _config$web6, _config$web$darkMode, _config$web7, _config$web$title, _config$web8, _config$web$scope, _config$web9, _config$web$pkgManage, _config$web10, _validatePrimaryColor, _config$web11;

  const {
    url_prefix
  } = config;
  const base = (0, _utils.getPublicUrl)(config === null || config === void 0 ? void 0 : config.url_prefix, req);
  const basename = new _url.URL(base).pathname;
  const language = (_config$i18n$web = config === null || config === void 0 ? void 0 : (_config$i18n = config.i18n) === null || _config$i18n === void 0 ? void 0 : _config$i18n.web) !== null && _config$i18n$web !== void 0 ? _config$i18n$web : DEFAULT_LANGUAGE;
  const needHtmlCache = [undefined, null].includes(config === null || config === void 0 ? void 0 : (_config$web6 = config.web) === null || _config$web6 === void 0 ? void 0 : _config$web6.html_cache) ? true : config.web.html_cache;
  const darkMode = (_config$web$darkMode = config === null || config === void 0 ? void 0 : (_config$web7 = config.web) === null || _config$web7 === void 0 ? void 0 : _config$web7.darkMode) !== null && _config$web$darkMode !== void 0 ? _config$web$darkMode : false;
  const title = (_config$web$title = config === null || config === void 0 ? void 0 : (_config$web8 = config.web) === null || _config$web8 === void 0 ? void 0 : _config$web8.title) !== null && _config$web$title !== void 0 ? _config$web$title : _constants.WEB_TITLE;
  const scope = (_config$web$scope = config === null || config === void 0 ? void 0 : (_config$web9 = config.web) === null || _config$web9 === void 0 ? void 0 : _config$web9.scope) !== null && _config$web$scope !== void 0 ? _config$web$scope : '';
  const login = (0, _utils.hasLogin)(config);
  const logoURI = resolveLogo(config, req);
  const pkgManagers = (_config$web$pkgManage = config === null || config === void 0 ? void 0 : (_config$web10 = config.web) === null || _config$web10 === void 0 ? void 0 : _config$web10.pkgManagers) !== null && _config$web$pkgManage !== void 0 ? _config$web$pkgManage : ['yarn', 'pnpm', 'npm'];
  const version = pkgJSON.version;
  const primaryColor = (_validatePrimaryColor = validatePrimaryColor(config === null || config === void 0 ? void 0 : (_config$web11 = config.web) === null || _config$web11 === void 0 ? void 0 : _config$web11.primary_color)) !== null && _validatePrimaryColor !== void 0 ? _validatePrimaryColor : '#4b5e40';
  const {
    scriptsBodyAfter,
    metaScripts,
    scriptsbodyBefore,
    showInfo,
    showSettings,
    showThemeSwitch,
    showFooter,
    showSearch,
    showDownloadTarball
  } = Object.assign({}, {
    scriptsBodyAfter: [],
    bodyBefore: [],
    metaScripts: []
  }, config === null || config === void 0 ? void 0 : config.web);
  const options = {
    showInfo,
    showSettings,
    showThemeSwitch,
    showFooter,
    showSearch,
    showDownloadTarball,
    darkMode,
    url_prefix,
    basename,
    base,
    primaryColor,
    version,
    pkgManagers,
    login,
    logo: logoURI,
    title,
    scope,
    language
  };
  let webPage;

  try {
    webPage = cache.get('template');

    if (!webPage) {
      debug('web options %o', options);
      debug('web manifestFiles %o', manifestFiles);
      webPage = (0, _template.default)({
        manifest: manifestFiles !== null && manifestFiles !== void 0 ? manifestFiles : defaultManifestFiles,
        options,
        scriptsBodyAfter,
        metaScripts,
        scriptsbodyBefore
      }, manifest);
      debug('template :: %o', webPage);

      if (needHtmlCache) {
        cache.set('template', webPage);
        debug('set template cache');
      }
    } else {
      debug('reuse template cache');
    }
  } catch (error) {
    throw new Error(`theme could not be load, stack ${error.stack}`);
  }

  res.setHeader('Content-Type', _commonsApi.HEADERS.TEXT_HTML);
  res.send(webPage);
  debug('render web');
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9hcGkvd2ViL2h0bWwvcmVuZGVySFRNTC50cyJdLCJuYW1lcyI6WyJwa2dKU09OIiwicmVxdWlyZSIsIkRFRkFVTFRfTEFOR1VBR0UiLCJjYWNoZSIsIkxSVSIsIm1heCIsIm1heEFnZSIsImRlYnVnIiwiZGVmYXVsdE1hbmlmZXN0RmlsZXMiLCJqcyIsImljbyIsInZhbGlkYXRlUHJpbWFyeUNvbG9yIiwicHJpbWFyeUNvbG9yIiwiaXNIZXgiLCJ0ZXN0IiwicmVzb2x2ZUxvZ28iLCJjb25maWciLCJyZXEiLCJpc0xvY2FsRmlsZSIsIndlYiIsImxvZ28iLCJ1cmxfcHJlZml4IiwicGF0aCIsImJhc2VuYW1lIiwicmVuZGVySFRNTCIsIm1hbmlmZXN0IiwibWFuaWZlc3RGaWxlcyIsInJlcyIsImJhc2UiLCJVUkwiLCJwYXRobmFtZSIsImxhbmd1YWdlIiwiaTE4biIsIm5lZWRIdG1sQ2FjaGUiLCJ1bmRlZmluZWQiLCJpbmNsdWRlcyIsImh0bWxfY2FjaGUiLCJkYXJrTW9kZSIsInRpdGxlIiwiV0VCX1RJVExFIiwic2NvcGUiLCJsb2dpbiIsImxvZ29VUkkiLCJwa2dNYW5hZ2VycyIsInZlcnNpb24iLCJwcmltYXJ5X2NvbG9yIiwic2NyaXB0c0JvZHlBZnRlciIsIm1ldGFTY3JpcHRzIiwic2NyaXB0c2JvZHlCZWZvcmUiLCJzaG93SW5mbyIsInNob3dTZXR0aW5ncyIsInNob3dUaGVtZVN3aXRjaCIsInNob3dGb290ZXIiLCJzaG93U2VhcmNoIiwic2hvd0Rvd25sb2FkVGFyYmFsbCIsIk9iamVjdCIsImFzc2lnbiIsImJvZHlCZWZvcmUiLCJvcHRpb25zIiwid2ViUGFnZSIsImdldCIsInNldCIsImVycm9yIiwiRXJyb3IiLCJzdGFjayIsInNldEhlYWRlciIsIkhFQURFUlMiLCJURVhUX0hUTUwiLCJzZW5kIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFFQTs7QUFD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QUFtQjtBQUNqQjlCLFFBQUFBLEtBQUssQ0FBQzBELEdBQU4sQ0FBVSxVQUFWLEVBQXNCRixPQUF0QjtBQUNBcEQsUUFBQUEsS0FBSyxDQUFDLG9CQUFELENBQUw7QUFDRDtBQUNGLEtBbEJELE1Ba0JPO0FBQ0xBLE1BQUFBLEtBQUssQ0FBQyxzQkFBRCxDQUFMO0FBQ0Q7QUFDRixHQXZCRCxDQXVCRSxPQUFPdUQsS0FBUCxFQUFjO0FBQ2QsVUFBTSxJQUFJQyxLQUFKLENBQVcsa0NBQWlDRCxLQUFLLENBQUNFLEtBQU0sRUFBeEQsQ0FBTjtBQUNEOztBQUNEckMsRUFBQUEsR0FBRyxDQUFDc0MsU0FBSixDQUFjLGNBQWQsRUFBOEJDLG9CQUFRQyxTQUF0QztBQUNBeEMsRUFBQUEsR0FBRyxDQUFDeUMsSUFBSixDQUFTVCxPQUFUO0FBQ0FwRCxFQUFBQSxLQUFLLENBQUMsWUFBRCxDQUFMO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYnVpbGREZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgTFJVIGZyb20gJ2xydS1jYWNoZSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IFVSTCB9IGZyb20gJ3VybCc7XG5cbmltcG9ydCB7IEhFQURFUlMgfSBmcm9tICdAdmVyZGFjY2lvL2NvbW1vbnMtYXBpJztcblxuaW1wb3J0IHsgV0VCX1RJVExFIH0gZnJvbSAnLi4vLi4vLi4vbGliL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBnZXRQdWJsaWNVcmwsIGhhc0xvZ2luLCBpc0hUVFBQcm90b2NvbCB9IGZyb20gJy4uLy4uLy4uL2xpYi91dGlscyc7XG5pbXBvcnQgcmVuZGVyVGVtcGxhdGUgZnJvbSAnLi90ZW1wbGF0ZSc7XG5cbmNvbnN0IHBrZ0pTT04gPSByZXF1aXJlKCcuLi8uLi8uLi8uLi9wYWNrYWdlLmpzb24nKTtcbmNvbnN0IERFRkFVTFRfTEFOR1VBR0UgPSAnZXMtVVMnO1xuY29uc3QgY2FjaGUgPSBuZXcgTFJVKHsgbWF4OiA1MDAsIG1heEFnZTogMTAwMCAqIDYwICogNjAgfSk7XG5cbmNvbnN0IGRlYnVnID0gYnVpbGREZWJ1ZygndmVyZGFjY2lvJyk7XG5cbmNvbnN0IGRlZmF1bHRNYW5pZmVzdEZpbGVzID0ge1xuICBqczogWydydW50aW1lLmpzJywgJ3ZlbmRvcnMuanMnLCAnbWFpbi5qcyddLFxuICBpY286ICdmYXZpY29uLmljbycsXG59O1xuXG5leHBvcnQgZnVuY3Rpb24gdmFsaWRhdGVQcmltYXJ5Q29sb3IocHJpbWFyeUNvbG9yKSB7XG4gIGNvbnN0IGlzSGV4ID0gL14jKyhbYS1mQS1GMC05XXs2fXxbYS1mQS1GMC05XXszfSkkL2kudGVzdChwcmltYXJ5Q29sb3IpO1xuICBpZiAoIWlzSGV4KSB7XG4gICAgZGVidWcoJ2ludmFsaWQgcHJpbWFyeSBjb2xvciAlbycsIHByaW1hcnlDb2xvcik7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgcmV0dXJuIHByaW1hcnlDb2xvcjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlc29sdmVMb2dvKGNvbmZpZywgcmVxKSB7XG4gIGNvbnN0IGlzTG9jYWxGaWxlID0gY29uZmlnPy53ZWI/LmxvZ28gJiYgIWlzSFRUUFByb3RvY29sKGNvbmZpZz8ud2ViPy5sb2dvKTtcblxuICBpZiAoaXNMb2NhbEZpbGUpIHtcbiAgICByZXR1cm4gYCR7Z2V0UHVibGljVXJsKGNvbmZpZz8udXJsX3ByZWZpeCwgcmVxKX0tL3N0YXRpYy8ke3BhdGguYmFzZW5hbWUoY29uZmlnPy53ZWI/LmxvZ28pfWA7XG4gIH0gZWxzZSBpZiAoaXNIVFRQUHJvdG9jb2woY29uZmlnPy53ZWI/LmxvZ28pKSB7XG4gICAgcmV0dXJuIGNvbmZpZz8ud2ViPy5sb2dvO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiAnJztcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiByZW5kZXJIVE1MKGNvbmZpZywgbWFuaWZlc3QsIG1hbmlmZXN0RmlsZXMsIHJlcSwgcmVzKSB7XG4gIGNvbnN0IHsgdXJsX3ByZWZpeCB9ID0gY29uZmlnO1xuICBjb25zdCBiYXNlID0gZ2V0UHVibGljVXJsKGNvbmZpZz8udXJsX3ByZWZpeCwgcmVxKTtcbiAgY29uc3QgYmFzZW5hbWUgPSBuZXcgVVJMKGJhc2UpLnBhdGhuYW1lO1xuICBjb25zdCBsYW5ndWFnZSA9IGNvbmZpZz8uaTE4bj8ud2ViID8/IERFRkFVTFRfTEFOR1VBR0U7XG4gIGNvbnN0IG5lZWRIdG1sQ2FjaGUgPSBbdW5kZWZpbmVkLCBudWxsXS5pbmNsdWRlcyhjb25maWc/LndlYj8uaHRtbF9jYWNoZSkgPyB0cnVlIDogY29uZmlnLndlYi5odG1sX2NhY2hlO1xuICBjb25zdCBkYXJrTW9kZSA9IGNvbmZpZz8ud2ViPy5kYXJrTW9kZSA/PyBmYWxzZTtcbiAgY29uc3QgdGl0bGUgPSBjb25maWc/LndlYj8udGl0bGUgPz8gV0VCX1RJVExFO1xuICBjb25zdCBzY29wZSA9IGNvbmZpZz8ud2ViPy5zY29wZSA/PyAnJztcbiAgY29uc3QgbG9naW4gPSBoYXNMb2dpbihjb25maWcpO1xuICBjb25zdCBsb2dvVVJJID0gcmVzb2x2ZUxvZ28oY29uZmlnLCByZXEpO1xuICBjb25zdCBwa2dNYW5hZ2VycyA9IGNvbmZpZz8ud2ViPy5wa2dNYW5hZ2VycyA/PyBbJ3lhcm4nLCAncG5wbScsICducG0nXTtcbiAgY29uc3QgdmVyc2lvbiA9IHBrZ0pTT04udmVyc2lvbjtcbiAgY29uc3QgcHJpbWFyeUNvbG9yID0gdmFsaWRhdGVQcmltYXJ5Q29sb3IoY29uZmlnPy53ZWI/LnByaW1hcnlfY29sb3IpID8/ICcjNGI1ZTQwJztcbiAgY29uc3QgeyBzY3JpcHRzQm9keUFmdGVyLCBtZXRhU2NyaXB0cywgc2NyaXB0c2JvZHlCZWZvcmUsIHNob3dJbmZvLCBzaG93U2V0dGluZ3MsIHNob3dUaGVtZVN3aXRjaCwgc2hvd0Zvb3Rlciwgc2hvd1NlYXJjaCwgc2hvd0Rvd25sb2FkVGFyYmFsbCB9ID0gT2JqZWN0LmFzc2lnbihcbiAgICB7fSxcbiAgICB7XG4gICAgICBzY3JpcHRzQm9keUFmdGVyOiBbXSxcbiAgICAgIGJvZHlCZWZvcmU6IFtdLFxuICAgICAgbWV0YVNjcmlwdHM6IFtdLFxuICAgIH0sXG4gICAgY29uZmlnPy53ZWJcbiAgKTtcbiAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICBzaG93SW5mbyxcbiAgICBzaG93U2V0dGluZ3MsXG4gICAgc2hvd1RoZW1lU3dpdGNoLFxuICAgIHNob3dGb290ZXIsXG4gICAgc2hvd1NlYXJjaCxcbiAgICBzaG93RG93bmxvYWRUYXJiYWxsLFxuICAgIGRhcmtNb2RlLFxuICAgIHVybF9wcmVmaXgsXG4gICAgYmFzZW5hbWUsXG4gICAgYmFzZSxcbiAgICBwcmltYXJ5Q29sb3IsXG4gICAgdmVyc2lvbixcbiAgICBwa2dNYW5hZ2VycyxcbiAgICBsb2dpbixcbiAgICBsb2dvOiBsb2dvVVJJLFxuICAgIHRpdGxlLFxuICAgIHNjb3BlLFxuICAgIGxhbmd1YWdlLFxuICB9O1xuXG4gIGxldCB3ZWJQYWdlO1xuXG4gIHRyeSB7XG4gICAgd2ViUGFnZSA9IGNhY2hlLmdldCgndGVtcGxhdGUnKTtcbiAgICBpZiAoIXdlYlBhZ2UpIHtcbiAgICAgIGRlYnVnKCd3ZWIgb3B0aW9ucyAlbycsIG9wdGlvbnMpO1xuICAgICAgZGVidWcoJ3dlYiBtYW5pZmVzdEZpbGVzICVvJywgbWFuaWZlc3RGaWxlcyk7XG4gICAgICB3ZWJQYWdlID0gcmVuZGVyVGVtcGxhdGUoXG4gICAgICAgIHtcbiAgICAgICAgICBtYW5pZmVzdDogbWFuaWZlc3RGaWxlcyA/PyBkZWZhdWx0TWFuaWZlc3RGaWxlcyxcbiAgICAgICAgICBvcHRpb25zLFxuICAgICAgICAgIHNjcmlwdHNCb2R5QWZ0ZXIsXG4gICAgICAgICAgbWV0YVNjcmlwdHMsXG4gICAgICAgICAgc2NyaXB0c2JvZHlCZWZvcmUsXG4gICAgICAgIH0sXG4gICAgICAgIG1hbmlmZXN0XG4gICAgICApO1xuICAgICAgZGVidWcoJ3RlbXBsYXRlIDo6ICVvJywgd2ViUGFnZSk7XG4gICAgICBpZiAobmVlZEh0bWxDYWNoZSkge1xuICAgICAgICBjYWNoZS5zZXQoJ3RlbXBsYXRlJywgd2ViUGFnZSk7XG4gICAgICAgIGRlYnVnKCdzZXQgdGVtcGxhdGUgY2FjaGUnKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgZGVidWcoJ3JldXNlIHRlbXBsYXRlIGNhY2hlJyk7XG4gICAgfVxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIHRocm93IG5ldyBFcnJvcihgdGhlbWUgY291bGQgbm90IGJlIGxvYWQsIHN0YWNrICR7ZXJyb3Iuc3RhY2t9YCk7XG4gIH1cbiAgcmVzLnNldEhlYWRlcignQ29udGVudC1UeXBlJywgSEVBREVSUy5URVhUX0hUTUwpO1xuICByZXMuc2VuZCh3ZWJQYWdlKTtcbiAgZGVidWcoJ3JlbmRlciB3ZWInKTtcbn1cbiJdfQ==